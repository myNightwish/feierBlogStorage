---
title: 项目2：去哪儿网：问题总结篇
date: 2021-12-13 00:13:14
tags: Vue
categories: 项目总结
cover: https://images.unsplash.com/photo-1638454909775-82b870c6580d?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=387&q=80
copyright_author: 飞儿 
copyright_url: https://www.nesxc.com/post/hexocc.html 
license: CC BY-NC-SA 4.0
license_url: https://creativecommons.org/licenses/by-nc-sa/4.0/
---

* 项目时间： 2020年10月大概
* 项目背景： 慕课网的项目学习时做的笔记
* 问题总结篇： 总结一些之前的问题（简洁版）

* 概述：去哪儿网的移动端页面的实现，其中有3大模块:
遇到的问题和优化点比较集中在搜索城市页面。主要包括：搜索城市的逻辑实现、手指滑动过程中的高度计算 和 更换城市过程中出现的一些问题。
在解决这些问题的过程中，又产生了新的问题并进行了优化。

### 1. localStorage解决变更城市名后，首页无法更新的问题  ###

* **原本需求：**不选的时候有一个默认城市，展示该城市数据，实现选中一次，展示新的城市数据

* **原本实现逻辑：**当用户每次进入页面，都在mounted钩子里会发ajax请求，并将Vuex中城市名的数据带过去

* #### **出现的问题：刷新了页面，城市又回到了默认城市上海** ####

  * **原因：**由于store里的数据是保存在运行内存中的,当页面刷新时，页面会重新加载vue实例，store里面的数据就会被重新赋值，就会使用state中默认保存的数据

  * **解决：**localStorage可以实现当有缓存值的时候用缓存值，没有才用默认值的功能，为什么选它？

    * localStorage是永久存储在本地，除非你主动去删除;
    * sessionStorage是存储到当前页面关闭为止;
    * cookie则根据你设置的有效时间来存储，但缺点是不能储存大数据且不易读取。

  * **新的问题：**

    引入localStorage，当用户重新选择了城市时，Vuex会更新state里面的city变量，此时城市名已经变动，此时应该进行ajax请求的。

    但同时由于对首页用了keep_alive，所以再次回到首页不会再执行mounted这个钩子了，进而无法在该钩子里做数据获取得操作，我们可以用activated

  * **网络请求优化：**

    **原因：**每点一个城市都会数据请求，假如点击前后城市并没更新，其实没有必要重新请求：

    **解决：**在首页activated新定义一个变量保存每次请求前的城市名，来对state里面的城市做if判断，只有二者不一致时才会去重新请求

    **实现：**首次请求后不会再次请求的问题；城市名实际未变化，也不会再次请求的问题

### 2. 实现手指滑动时的更准确的高度计算并优化计算性能； ###

* 需求：在右侧字母表上下拖拽时，左边对应的城市列表自动上下滚动
* 绑定touch相关的3个事件：touchstart、touchmove、touchend。设置标识位，在start里面将标识位更新为true，在move里判断标识位为true时才进行高度的计算。在touchend中将标识位false。

* 高度计算：

  * 获得字母A距离顶部的高度A ：·`this.$refs['A'][0].offsetTop`DOM元素距离顶部的距离 ，再拿到当前手指滑动个位置距离顶部的高度B ：通过事件对象里面的touche数组，e.touches[0].clientY，相减的高度差除以一个字母的高度20，就拿到了当前字母对应的索引，然后从存储字母的数组中取出来。

* 优化：每次执行一次move，都要获取dom结构的offsetTOP属性进行一次计算。这是没有必要的且耗费性能的                                                  **JS方面的优化**
  * 字母A距离顶部的高度A，在初次渲染这个组件的时候数据还是空的，而当ajax数据获取后，往这个组件传的数据改变，updated生命周期钩子就会执行，页面中显示出了列表的内容。这个时候去获取就能得到字母A所在的DOM对应的offsetTop的值不仅是准确的，还能解决耗费性能的问题
  * 引入防抖操作，在touchmove中，如果标志位为true，就清空定时器，并且设置新的定时器，将高度计算的操作放在定时器里

### 3. 城市名搜索的逻辑实现 ###

* 需求：

  * 搜索框搜索城市名或拼音，显示对应的搜索结果，并引入防抖降低搜索过程中查找匹配函数的频率
  * 当匹配不到城市时，显示无法匹配
  * 匹配的城市可以滚动显示
* 实现：
* 搜索框通过**v-model双向绑定**数据keyword，在**侦听器watch**中监听keyword的改变，当它发生改变时，代表用户正在输入。
  * 此时对cities对象进行遍历，cities里每一项都包含了indexof一个城市的名字name和拼音。只要输入的内容能匹配其中之一，就将匹配到的城市数据加入到list列表中。然后对list列表中的数据在li组件中循环显示出来。
* 在循环列表末尾添加一项li，用于展示是否无法匹配，当匹配不到城市时，通过**v-show**控制，显示匹配不到该城市
  * 滚动：将这个组件绑定ref，在mounted阶段，通过**refs拿到DOM元素**，传入**new BetterScroll**中，然后实现局部滚动