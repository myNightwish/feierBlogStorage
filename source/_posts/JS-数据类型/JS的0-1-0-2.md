---
title: JS的0.1+0.2
tags: JS
categories: JS
comments: true
description: 为什么计算机中0.1+0.2≠0.3？
cover: >-
  https://images.unsplash.com/photo-1639051140636-c643758b5496?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80
abbrlink: 2217063026
date: 2021-12-11 00:39:07
---

### 0.1+0.2 !=0.3 ###

* 0.1的二进制是`0.0001100110011001100...`（1100循环），0.2的二进制是：`0.00110011001100...`（1100循环），这两个数的二进制都是无限循环的数

* 在 JavaScript 中只有一种数字类型：Number，它的实现遵循IEEE 754标准，使用64位固定长度来表示，也就是标准的double双精度浮点数。保存格式如下：

  <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0cb225cf71d748a8b2d6a5615e402711~tplv-k3u1fbpfcp-watermark.awebp" alt="img" style="zoom: 50%;" />

  * 第一部分（蓝色）：用来存储符号位（sign），用来区分正负数，0表示正数，占用1位
  * 第二部分（绿色）：用来存储指数（exponent），占用11位
  * 第三部分（红色）：用来存储小数（fraction），占用52位

* 所以双精度浮点数的小数部分最多只能保留52位，再加上前面的1，其实就是保留53位有效数字，剩余的需要舍去，遵从“0舍1入”的原则。

  * 对于0.1，它的二进制为：

    ```javascript
    0.00011001100110011001100110011001100110011001100110011001 10011...
    ```

    转为科学计数法（科学计数法的结果就是浮点数）：

    ```javascript
    1.1001100110011001100110011001100110011001100110011001*2^-4
    ```

    可以看出0.1的符号位为0，指数位为-4，小数位为：

    ```javascript
    1001100110011001100110011001100110011001100110011001
    ```

    **指数位是负数，该如何保存**呢？

* IEEE标准规定了一个偏移量，对于指数部分，每次都加这个偏移量进行保存，这样即使指数是负数，那么加上这个偏移量也就是正数了。由于JavaScript的数字是双精度数，这里就以双精度数为例，它的指数部分为11位，能表示的范围就是0~2047，IEEE固定**双精度数的偏移量为1023**。

  * 当指数位不全是0也不全是1时(规格化的数值)，IEEE规定，阶码计算公式为 e-Bias。 此时e最小值是1，则1-1023= -1022，e最大值是2046，则2046-1023=1023，可以看到，这种情况下取值范围是`-1022~1013`。
  * 当指数位全部是0的时候(非规格化的数值)，IEEE规定，阶码的计算公式为1-Bias，即1-1023= -1022。
  * 当指数位全部是1的时候(特殊值)，IEEE规定这个浮点数可用来表示3个特殊值，分别是正无穷，负无穷，NaN。 具体的，小数位不为0的时候表示NaN；小数位为0时，当符号位s=0时表示正无穷，s=1时候表示负无穷。

  对于上面的0.1的指数位为-4，-4+1023 = 1019 转化为二进制就是：`1111111011`.

```javascript
0 1111111011 1001100110011001100110011001100110011001100110011001
```

#### 如何实现0.1+0.2=0.3呢？ ####

对于这个问题，一个直接的解决方法就是设置一个误差范围，通常称为“机器精度”。对JavaScript来说，这个值通常为2-52，在ES6中，提供了`Number.EPSILON`属性，而它的值就是2-52，只要判断`0.1+0.2-0.3`是否小于`Number.EPSILON`，如果小于，就可以判断为0.1+0.2 ===0.3

```javascript
function numberepsilon(arg1,arg2){                   
  return Math.abs(arg1 - arg2) < Number.EPSILON;        
}        

console.log(numberepsilon(0.1 + 0.2, 0.3)); // true
```
